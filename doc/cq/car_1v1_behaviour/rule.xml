<?xml version="1.0" encoding="utf-8"?>
<?xml-model href="example1.0.xsd"?>
<RuleSet version="1.0">
    <TypeDefines>
        <TypeDefine type="Location">
            <Variable name="altitude" type="float64" />
            <Variable name="longitude" type="float64" />
            <Variable name="latitude" type="float64" />
        </TypeDefine>
        <TypeDefine type="Vector3">
            <Variable name="x" type="float64" />
            <Variable name="y" type="float64" />
            <Variable name="z" type="float64" />
        </TypeDefine>
        <TypeDefine type="BaseInfo">
            <Variable name="id" type="uint64"/>
            <Variable name="side" type="uint16"/>
            <Variable name="type" type="uint16"/>
            <Variable name="damageLevel" type="uint16"/>
        </TypeDefine>
        <TypeDefine type="EntityInfo">
            <Variable name="baseInfo" type="BaseInfo"/>
            <Variable name="velocity" type="Vector3"/>
            <Variable name="position" type="Vector3"/>
        </TypeDefine>
        <TypeDefine type="WeaponInfo">
            <Variable name="ammo" type="int32"/>
            <Variable name="reloadingState" type="float64"/>
            <Variable name="range" type="float64"/>
            <Variable name="direction" type="float64"/>
            <Variable name="weaponName" type="string"/>
        </TypeDefine>
    </TypeDefines>
    <MetaInfo>
        <Inputs>
            <Param name="selfInfo" type="EntityInfo"/>
            <Param name="scannedInfo" type="EntityInfo[]"/>
            <Param name="roll" type="float64"/>
            <Param name="pitch" type="float64"/>
            <Param name="yaw" type="float64"/>
            <Param name="weaponinfo" type="WeaponInfo[]"/>
        </Inputs>
        <Outputs>
            <Param name="ActionId" type="uint64"/>
            <Param name="Param1" type="float64"/>
            <Param name="Param2" type="float64"/>
        </Outputs>
        <Caches>
            <Param name="head_index" type="float64">
                <Value>
                    <Expression>
                        {
                            var head_id = -1
                            var i = 0
                            while(i &lt; scannedInfo.length()){
                                if (selfInfo.baseInfo.side == scannedInfo[i].baseInfo.side and (scannedInfo[i].baseInfo.damageLevel == 0 or scannedInfo[i].baseInfo.damageLevel == 1)){
                                    if (head_id == -1) {
                                        head_id = i
                                    } else if (scannedInfo[i].baseInfo.id &lt; scannedInfo[head_id].baseInfo.id) {
                                        head_id = i
                                    }
                                }
                                i = i + 1
                            }
                            head_id
                        }
                    </Expression>
                </Value>
            </Param>
            <Param name="enemy_head_index" type="float64">
                <Value>
                    <Expression>
                        {
                            var head_id = -1
                            var i = 0
                            while(i &lt; scannedInfo.length()){
                                if (selfInfo.baseInfo.side != scannedInfo[i].baseInfo.side and (scannedInfo[i].baseInfo.damageLevel == 0 or scannedInfo[i].baseInfo.damageLevel == 1)){
                                    if (head_id == -1) {
                                        head_id = i
                                    } else if (scannedInfo[i].baseInfo.id &lt; scannedInfo[head_id].baseInfo.id) {
                                        head_id = i
                                    }
                                }
                                i = i + 1
                            }
                            head_id
                        }
                    </Expression>
                </Value>
            </Param>
            <Param name="distance" type="float64">
                <Value>
                    <Expression>
                        if (head_index != -1 and enemy_head_index != -1) {
                            var dis = pow((scannedInfo[head_index].position.x - scannedInfo[enemy_head_index].position.x), 2) + 
                                pow((scannedInfo[head_index].position.z - scannedInfo[enemy_head_index].position.z), 2) + 
                                pow((scannedInfo[head_index].position.y - scannedInfo[enemy_head_index].position.y), 2)
                            pow(dis, 0.5)
                        } else 50000
                    </Expression>
                </Value>
            </Param>
            <Param name="realyaw" type="float64">
                <Value>
                    <Expression>
                        yaw * 3.1415926 / 180 + 3.1415926 / 2
                    </Expression>
                </Value>
            </Param>
            <Param name="yawdiff" type="float64">
                <Value>
                    <Expression>
                        if (head_index == -1 or (scannedInfo[head_index].baseInfo.id == selfInfo.baseInfo.id)) 0
                        else atan2(
                            scannedInfo[head_index].position.y - selfInfo.position.y,
                            scannedInfo[head_index].position.x - selfInfo.position.x
                        ) - realyaw
                    </Expression>
                </Value>
            </Param>
            <Param name="position_diff" type="Vector3">
                <Value>
                    <Expression>
                        if (head_index == -1 or enemy_head_index == -1) {
                            Vector3{.x = 0, .y = 0, .z = 0}
                        } else {
                            var diff = selfInfo.baseInfo.id - head_index
                            var target_v = scannedInfo[head_index].velocity
                            var n = pow(target_v.x * target_v.x + target_v.y * target_v.y, 0.5)
                            var sin_yaw = target_v.y / n
                            var cos_yaw = target_v.x / n
                            var tar = scannedInfo[enemy_head_index].position
                            if (distance > 5000) {
                                tar.x = tar.x - 15 * cos_yaw * diff
                                tar.y = tar.y - 15 * sin_yaw * diff
                            } else {
                                var side = if ((selfInfo.baseInfo.id - head_index) % 2) 1 else -1
                                diff = floor(diff / 2 + 0.6)
                                tar.x = tar.x - 10 * sin_yaw * diff * side
                                tar.y = tar.y - 10 * cos_yaw * diff * side
                            }
                            tar.x = tar.x - selfInfo.position.x
                            tar.y = tar.y - selfInfo.position.y
                            tar.z = 0
                            tar
                        }
                    </Expression>
                </Value>
            </Param>
            <Param name="v_exp" type="Vector3">
                <Value>
                    <Expression>
                        {
                            var K1 = 1
                            var K2 = 5
                            var v_target = if (head_index == -1) Vector3{.x = 0, .y = 0, .z = 0} else scannedInfo[head_index].velocity
                            Vector3{
                                .x = v_target.x + K1 * position_diff.x + K2 * (v_target.x - selfInfo.velocity.x),
                                .y = v_target.y + K1 * position_diff.y + K2 * (v_target.y - selfInfo.velocity.y),
                                .z = 0
                            }
                        }
                    </Expression>
                </Value>
            </Param>
            <Param name="attacked" type="float64"/>
            <Param name="start_fire" type="float64"/>
        </Caches>
    </MetaInfo>
    <SubRuleSets>
        <SubRuleSet>
            <Rules>
                <Rule>
                    <Condition>
                        <Expression>(not attacked) and distance &lt; 500</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>attacked</Target>
                            <Value>
                                <Expression>true</Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
            </Rules>
        </SubRuleSet>
        <SubRuleSet>
            <Rules>
                <Rule>
                    <Condition>
                        <Expression>head_index == -1 or enemy_head_index == -1</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>ActionId</Target>
                            <Value>
                                <Expression>5</Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
                <Rule>
                    <Condition>
                        <Expression>distance &lt; 4000 and not start_fire</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>start_fire</Target>
                            <Value>
                                <Expression>true</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>ActionId</Target>
                            <Value>
                                <Expression>11</Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
                <Rule>
                    <Condition>
                        <Expression>scannedInfo[head_index].baseInfo.id == selfInfo.baseInfo.id and distance &gt; 5000</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>ActionId</Target>
                            <Value>
                                <Expression>7</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>Param1</Target>
                            <Value>
                                <Expression>20</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>Param2</Target>
                            <Value>
                                <Expression>
                                    atan2(
                                        scannedInfo[enemy_head_index].position.y - selfInfo.position.y,
                                        scannedInfo[enemy_head_index].position.x - selfInfo.position.x
                                    )
                                </Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
                <Rule>
                    <Condition>
                        <Expression>attacked</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>ActionId</Target>
                            <Value>
                                <Expression>5</Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
                <Rule>
                    <Condition>
                        <Expression>scannedInfo[head_index].baseInfo.id == selfInfo.baseInfo.id</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>ActionId</Target>
                            <Value>
                                <Expression>7</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>Param1</Target>
                            <Value>
                                <Expression>25</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>Param2</Target>
                            <Value>
                                <Expression>
                                    atan2(
                                        scannedInfo[enemy_head_index].position.y - selfInfo.position.y,
                                        scannedInfo[enemy_head_index].position.x - selfInfo.position.x
                                    )
                                </Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
                <Rule>
                    <Condition>
                        <Expression>true</Expression>
                    </Condition>
                    <Consequence>
                        <Assignment>
                            <Target>ActionId</Target>
                            <Value>
                                <Expression>7</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>Param1</Target>
                            <Value>
                                <Expression>pow(pow(v_exp.x, 2) + pow(v_exp.y, 2), 0.5)</Expression>
                            </Value>
                        </Assignment>
                        <Assignment>
                            <Target>Param2</Target>
                            <Value>
                                <Expression>atan2(v_exp.y, v_exp.x)</Expression>
                            </Value>
                        </Assignment>
                    </Consequence>
                </Rule>
            </Rules>
        </SubRuleSet>
    </SubRuleSets>
</RuleSet>